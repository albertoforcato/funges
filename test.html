<!DOCTYPE html>
<html lang="en">
<head>
  <!--
  <script id="Cookiebot" src="https://consent.cookiebot.com/uc.js" data-cbid="a5b94f7b-052a-4c20-ad48-7d6609a12279" type="text/javascript"></script> 
   -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Porcini Mushroom Map</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/lodist/tripped-map/main/logo_1.png">
  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100dvh; /* Use dynamic viewport height where supported */
      overflow: hidden; /* Disable scrolling */
    }
    
    /* Splash Screen */
    #splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 252, 239, 0.90); /* Same white halo color */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000; /* Ensure it stays on top */
        animation: fadeOut 4s ease-out forwards;
    }
    
    /* Make the splash screen logo smaller */
    #splash-screen img {
        width: 60vw; /* 60% of the viewport width */
        max-width: 550px; /* Optional: prevent it from getting too big on large screens */
        height: auto; /* Maintain aspect ratio */
    }

    
    /* Fade out animation */
    @keyframes fadeOut {
        0% { opacity: 1; }
        100% { opacity: 0; visibility: hidden; }
    }

    #map {
      height: calc(100dvh - 40px); /* Subtract the footer height from the viewport height */
      position: relative;
    }
    
    #button-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: calc(100dvh - 40px); /* Same height as the map */
      width: 80px;
      background-color: rgba(255, 252, 239, 0.90);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      overflow-x: hidden;
    }
        
    #footer {
      height: 40px; /* Footer height */
      background-color: rgba(255, 252, 239, 1); /* Footer background */
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 0 0 0 0px;
    }
        
    #footer a {
      font-size: 12px; /* Smaller text size */
      margin: 0 10px; /* Reduced spacing between links */
      text-decoration: none;
      color: #333; /* Text color */
      font-weight: normal; /* Make the font weight normal */
    }
        
    #footer a:hover {
      text-decoration: underline; /* Underline on hover */
    }
    
    #loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000; /* Ensures it's above all other elements */
      display: flex;
      justify-content: center;
      align-items: center;
      background: none; /* Remove background color */
      padding: 0; /* Remove padding around the spinner */
      border-radius: 0; /* No border radius */
    }
    
    #loading-spinner img {
      width: 260px; /* Adjust spinner size */
      height: auto;
    }


    /* Adjustments for mobile devices */
    @media (max-width: 768px) {
      #map {
        height: calc(100vh - 40px); /* Fallback for mobile browsers that don't support dynamic viewport units */
        margin-bottom: 35px; /* Add spacing below the map if needed */
      }
      
      #button-bar {
        height: calc(100vh - 40px); /* Adjust height for mobile */
      }
    }
  
    .button {
      margin: 12px 0; /* Adjust spacing between buttons */
      cursor: pointer;
    }
    .logo {
      margin-bottom: 18px; /* Adjust spacing below the logo */
    }
    .button img {
      width: 40px;
      height: auto;
    }
    .logo img {
      width: 65px;
      height: auto;
    }
    .mapboxgl-ctrl-top-right {
      top: 70px; /* Moves the controls down from the top */
      right: 9px; /* Keeps them px away from the right edge */
    }

    #legend {
      position: absolute;
      bottom: 150px;
      left: 90px;
      padding: 15px;
      border-radius: 8px;
      font-size: 12px; /* Reduced font size */
      background: rgba(255, 252, 239, 0.90); /* Matches the halo color and opacity */
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Soft halo effect */
      display: none; /* Hidden by default */
    }
    #legend h3 {
      margin: 0 0 10px;
      font-size: 12px; /* Reduced font size for heading */
    }
    .legend-scale {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 3px;
    }
    .legend-color.yellow {
      background: #ffffcc;
    }
    .legend-color.orange {
      background: #fbae7e;
    }
    .legend-color.red {
      background: #800020;
    }
    
    /* Image Upload Mask (Popup) */
    #image-mask {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
    }
    
    #image-mask-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        width: 80%;
        max-width: 400px;
    }
    
    #drop-zone {
        width: 100%;
        height: 150px;
        border: 2px dashed #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
        font-size: 16px;
        color: #555;
    }

    #prediction-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 252, 239, 0.90); /* Same color as the halo */
        padding: 12px;
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        display: none; /* Hidden by default */
        z-index: 1000;
        min-width: 50%;
    }

  </style>
</head>
<body>
  
  <div id="map"></div>
  
  <!-- Splash Screen -->
  <div id="splash-screen">
      <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/logo_funges.png" alt="Logo">
  </div>
  
  <!-- Button Bar -->
  <div id="button-bar">
    <div class="logo">
      <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/logo_1.png" alt="Logo">
    </div>
    <!-- Picture Button -->
    <div class="button" onclick="openImageMask()">
        <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/id_mushroom.png" alt="Mushroom ID Button">
    </div>
    <div class="button" onclick="locateUser()">
      <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/location_1.png" alt="Locate Me Button">
    </div>
    <div class="button" onclick="toggleDarkLayers()">
      <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/sunmoon_1.png" alt="Sun/Moon Button">
    </div>
    <div class="button" onclick="toggleNumbersLayers()">
      <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/numbers_1.png" alt="Numbers Button">
    </div>
    <div class="button">
      <a href="instructions.html">
        <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/info_1.png" alt="Info Button">
      </a>
    </div>

    <!-- Image Upload Mask (Popup) -->
    <div id="image-mask">
        <div id="image-mask-content">
            <p>Drag an image here or use the camera</p>
            <!-- Hidden File Input for Manual Upload -->
            <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handleImage(event)" style="display: none;">
            <!-- Button to trigger File Selection -->
            <button onclick="document.getElementById('fileInput').click()" style="font-size: 24px;">ðŸ“·</button>
            <!-- Drop Zone -->
            <div id="drop-zone">Drop Image Here</div>
            <!-- Result Display -->
            <div id="result" style="margin-top: 15px; font-size: 12px; font-weight: bold;"></div>
        </div>
    </div>

    <div class="button">
      <a href="https://www.patreon.com/Funges" target="_blank">
        <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/support_1.png" alt="Support Button">
      </a>
    </div>
    
    <div class="button">
      <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/gmaps_1.png" alt="Google Maps Button">
    </div>
  </div>

  <!-- Footer -->
  <div id="footer">
    <a href="impressum.html">Impressum</a>
    <a href="privacy-policy.html">Privacy Policy</a>
    <a href="termsuse.html">Terms of Use</a>
  </div>

  <!-- Legend -->
  <div id="legend">
    <h3>Porcini Mushroom Conditions</h3>
    <div class="legend-scale">
      <div class="legend-color yellow"></div> <span>Nah</span>
      <div class="legend-color orange"></div> <span>Alright</span>
      <div class="legend-color red"></div> <span>Let's Go!</span>
    </div>
    <p>Rating: 0 to 10</p>
    <p>
      <strong>Go to Location:</strong><br>
      <strong>Long Press (Mobile)</strong> / <strong>Right-Click (Desktop)</strong>:<br>
        Mark the target location<br>
        Click the button to the left to open in Google Maps.<br>
    </p>
    </div>

    <!-- Loading Spinner -->
  <div id="loading-spinner" style="display: none;">
    <img src="https://raw.githubusercontent.com/lodist/tripped-map/main/loading_1.gif" alt="Loading">
  </div>
  
  <!-- Prediction Result Box -->
  <div id="prediction-box">
      <p id="prediction-text">Prediction will appear here</p>
  </div>

  <!-- Class Names -->
  <script src="https://pub-92765923660e431daff3170fbef6471d.r2.dev/class_names.js"></script>

  <!-- TensorFlow.js & TFLite -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite"></script>

  <!-- Load script.js AFTER TensorFlow -->
  <script src="script.js"></script>

    <!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<!-- Leaflet.js for OSM Fallback -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Mapbox Access Token
    mapboxgl.accessToken = 'pk.eyJ1IjoibG9kaXN0IiwiYSI6ImNtM3g3dTVuaTE2dW8yaXM1eDE1dXVmZG4ifQ.xrGoky5Mzc6gwO5z8n6CoA';

    let map = null;
    let usingMapbox = true; // Track whether Mapbox is active
    let userMarker = null;
    let flagpoleMarker = null;

    function loadMapbox() {
        if (!mapboxgl.accessToken || mapboxgl.accessToken === 'null') {
            console.warn('Mapbox token missing or invalid. Switching to OpenStreetMap.');
            switchToOSM();
            return;
        }

        try {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/lodist/clzo3ivsk007d01piaoah1dfy',
                center: [7.3359, 47.7508], 
                zoom: 4,
                maxZoom: 20,
                minZoom: 4,
                collectResourceTiming: false,
                performanceMetricsCollection: false
            });

            map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'top-right');
            map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

            // Handle WebGL context loss
            map.on('webglcontextlost', () => {
                console.error('WebGL context lost. Switching to OSM.');
                switchToOSM();
            });

            // Handle Mapbox errors (e.g., invalid token)
            map.on('error', (e) => {
                console.error('Mapbox error:', e);
                alert('Failed to load Mapbox. Switching to OpenStreetMap.');
                switchToOSM();
            });

        } catch (error) {
            console.error('Mapbox initialization failed:', error);
            switchToOSM();
        }
    }

    function switchToOSM() {
        console.log('Switching to OpenStreetMap...');
        usingMapbox = false;

        // Remove Mapbox instance
        if (map && map.remove) {
            map.remove();
        }

        // Reset markers if they exist
        if (userMarker) {
            userMarker.remove();
            userMarker = null;
        }
        if (flagpoleMarker) {
            flagpoleMarker.remove();
            flagpoleMarker = null;
        }

        // Initialize OSM with Leaflet
        map = L.map('map').setView([47.7508, 7.3359], 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        console.log('OpenStreetMap loaded.');
    }

    function saveMapState() {
        if (!map) return;

        const mapState = {
            center: usingMapbox ? map.getCenter() : map.getCenter(),
            zoom: usingMapbox ? map.getZoom() : map.getZoom()
        };

        localStorage.setItem('mapState', JSON.stringify(mapState));
    }

    function restoreMapState() {
        try {
            const savedState = JSON.parse(localStorage.getItem('mapState'));
            if (savedState && map) {
                if (usingMapbox) {
                    map.setCenter(savedState.center);
                    map.setZoom(savedState.zoom);
                } else {
                    map.setView([savedState.center.lat, savedState.center.lng], savedState.zoom);
                }
                console.log('Map state restored.');
            }
        } catch (error) {
            console.error('Failed to load map state:', error);
        }
    }

    function locateUser() {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
            return;
        }

        const spinner = document.getElementById('loading-spinner');
        spinner.style.display = 'flex';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const coordinates = [position.coords.longitude, position.coords.latitude];

                if (userMarker) userMarker.remove();

                if (usingMapbox) {
                    const pinElement = document.createElement('img');
                    pinElement.src = 'https://raw.githubusercontent.com/lodist/tripped-map/main/pin_1.png';
                    pinElement.style.width = '40px';
                    pinElement.style.height = 'auto';

                    userMarker = new mapboxgl.Marker({ element: pinElement })
                        .setLngLat(coordinates)
                        .addTo(map);

                    map.flyTo({ center: coordinates, zoom: 8, speed: 2 });

                } else {
                    userMarker = L.marker([coordinates[1], coordinates[0]]).addTo(map);
                    map.setView([coordinates[1], coordinates[0]], 8);
                }

                spinner.style.display = 'none';
            },
            (error) => {
                spinner.style.display = 'none';
                alert("Unable to retrieve your location.");
                console.error(error);
            }
        );
    }

    window.onload = function () {
        console.log("Window loaded. Initializing Map...");
        if (mapboxgl.accessToken && mapboxgl.accessToken !== 'null') {
            console.log("Trying to load Mapbox...");
            loadMapbox();
        } else {
            console.warn("Mapbox token missing. Switching to OSM...");
            switchToOSM();
        }

        // Splash screen fade-out
        const splashScreen = document.getElementById('splash-screen');
        if (splashScreen) {
            splashScreen.addEventListener('animationend', () => {
                splashScreen.remove();
            });
        }

        restoreMapState();
    };

    // Save map state before unloading
    window.addEventListener('beforeunload', saveMapState);

    // Resize the map properly when tab is refocused
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            if (usingMapbox) {
                map.resize();
            } else {
                map.invalidateSize();
            }
        }
    });

    function toggleUserMarker(coordinates) {
        if (userMarker) {
            userMarker.remove();
            userMarker = null;
            console.log('User marker removed');
        } else {
            const pinElement = document.createElement('img');
            pinElement.src = 'https://raw.githubusercontent.com/lodist/tripped-map/main/pin_1.png';
            pinElement.style.width = '40px';
            pinElement.style.height = 'auto';

            userMarker = new mapboxgl.Marker({ element: pinElement })
                .setLngLat(coordinates)
                .addTo(map);

            console.log('User marker added:', coordinates);
        }

        map.flyTo({ center: coordinates, zoom: 8, speed: 2 });
    }

</script>

</body>
</html>
